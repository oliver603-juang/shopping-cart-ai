<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºæ…§è³¼ç‰©è»Š | ç¶ è‰²è«è˜­è¿ªé¢¨æ ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --------------------- GREEN MORANDI THEME --------------------- */
        :root {
            --bg-main: #F9F7F3; /* æ·ºç±³ç™½/ç°ç™½ */
            --color-text: #333333;
            --accent-green: #A8B5A3; /* æŸ”å’Œç°ç¶  (Primary) */
            --accent-green-dark: #7D8B7E; /* æ²‰ç©©æ·±ç¶  */
            --accent-pink: #E4C7C2; /* æ·ºæŸ”ç²‰ (Secondary) */
            --accent-pink-dark: #DDA0A0; /* æ·ºæš–æ©˜/ä¹¾ç‡¥ç«ç‘° (Success/Highlight) */
            --color-light-gray: #E5E7EB; /* Gray-200 */
        }
        
        body { 
            background-color: var(--bg-main); 
            color: var(--color-text); 
            font-family: 'Noto Sans TC', sans-serif; 
        }
        .app-container {
            background-color: #ffffff; /* å…§å®¹å€å¡Šä½¿ç”¨ç™½è‰² */
            border: 1px solid var(--color-light-gray);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        /* è¼¸å…¥æ¡†å’Œå‹¾é¸æ¨£å¼ */
        .item-input { 
            background: transparent; 
            border: none; 
            color: inherit; 
            outline: none; 
            font-size: 1rem; 
        }
        .item-input:focus { 
            border-bottom: 1px solid var(--accent-green); 
        }
        .name-input { width: 100%; font-weight: 500; }
        .price-input { width: 80px; text-align: right; transition: all 0.3s; }
        
        /* å‹¾é¸å¾Œæ¨£å¼ */
        .checked-item input.name-input { 
            text-decoration: line-through; 
            color: var(--color-light-gray); /* æ·ºè‰²åˆªé™¤ç·š */
        }
        .checked-item { opacity: 0.7; } 
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* AI Input Wrapper æ•ˆæœ */
        .ai-input-wrapper {
            border: 1px solid var(--color-light-gray);
            background-color: var(--bg-main);
            transition: all 0.3s;
        }
        .ai-input-wrapper:focus-within { 
            box-shadow: 0 0 10px rgba(168, 181, 163, 0.4); /* æŸ”å’Œç°ç¶ é™°å½± */
            border-color: var(--accent-green); 
        }
        
        /* æˆåŠŸå‹•ç•« (ä½¿ç”¨ Accent-Pink) */
        @keyframes flash-success-theme { 0% { background-color: rgba(228, 199, 194, 0.5); } 100% { background-color: transparent; } }
        .flash-success { animation: flash-success-theme 1.5s ease-out; }

        /* è¦å‰‡æ¨™ç±¤ */
        .rule-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: var(--accent-green-dark);
            color: var(--bg-main);
            border: 1px solid var(--accent-green);
            margin-left: 5px;
            display: inline-block;
            white-space: nowrap;
        }
        
        /* å‹•æ…‹ç‹€æ…‹æ–‡å­— */
        .dynamic-status {
            font-size: 0.7rem;
            margin-left: 4px;
            padding: 1px 4px;
            border-radius: 3px;
        }
        /* 3ä»¶77æŠ˜ - ç¶ è‰² */
        .status-77 { background-color: var(--accent-green-dark); color: #DCFCE7; border: 1px solid #16A34A; } 
        /* 2ä»¶79æŠ˜ - æ·ºæš–æ©˜ */
        .status-79 { background-color: var(--accent-pink-dark); color: var(--bg-main); border: 1px solid var(--accent-pink); } 
        .status-none { color: #9ca3af; font-size: 0.65rem; }

        /* ä¿ƒéŠ·æŒ‰éˆ•æ¨£å¼ */
        .promo-btn {
            font-size: 0.75rem; 
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid var(--accent-green);
            background-color: var(--color-light-gray);
            color: var(--color-text);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            white-space: nowrap;
            box-shadow: 0 2px 0 0 var(--accent-pink);
        }
        .promo-btn:hover {
            background-color: var(--accent-pink);
            color: var(--color-text);
            border-color: var(--accent-pink-dark);
            box-shadow: 0 2px 0 0 var(--accent-green-dark);
        }
        .promo-btn.dynamic {
            border-color: var(--accent-pink-dark); 
            color: var(--accent-pink-dark);
            background-color: var(--accent-pink);
        }
        .promo-btn.dynamic:hover {
            background-color: var(--accent-pink-dark);
            color: white;
        }
        
        /* è¨ˆç®—ç¸½è¨ˆæŒ‰éˆ• */
        .calc-btn {
            background-color: var(--accent-green-dark);
            color: white;
            box-shadow: 0 4px 0 0 var(--accent-pink-dark);
            transition: all 0.2s;
        }
        .calc-btn:hover {
            background-color: var(--accent-green);
            box-shadow: 0 4px 0 0 var(--accent-pink);
        }
        .calc-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md app-container rounded-lg shadow-xl p-6 relative">
        
        <!-- API Key -->
        <button id="apiKeyBtn" class="absolute top-4 right-4 text-gray-500 hover:text-[var(--accent-green)] transition-colors" title="è¨­å®š API Key">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
            </svg>
        </button>

        <div class="mb-4 pr-8">
            <h1 class="text-xl font-bold text-[var(--color-text)] flex items-center gap-2">
                è³¼ç‰©è»Šæ¸…å–®
                <span class="text-xs font-normal text-[var(--accent-pink-dark)] border border-[var(--accent-pink-dark)] px-1 rounded">v16 ç¶ è‰²è«è˜­è¿ª</span>
            </h1>
            <div class="mt-2 flex gap-2">
                 <select id="currencySelector" class="flex-1 bg-[var(--color-light-gray)] text-sm text-[var(--color-text)] border border-[var(--color-light-gray)] rounded px-2 py-1 outline-none focus:border-[var(--accent-green)]">
                    <option value="TWD">ğŸ‡¹ğŸ‡¼ å°å¹£ (TWD)</option>
                    <option value="JPY">ğŸ‡¯ğŸ‡µ æ—¥å¹£ (JPY)</option>
                    <option value="CNY">ğŸ‡¨ğŸ‡³ äººæ°‘å¹£ (CNY)</option>
                </select>
                <span id="loadingBlock" class="hidden flex items-center text-sm text-[var(--accent-green)] px-2 bg-[var(--color-light-gray)] rounded border border-[var(--accent-green)]">
                    <svg class="animate-spin-custom h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span id="loadingText">è™•ç†ä¸­...</span>
                </span>
            </div>
        </div>

        <!-- AI Input -->
        <div class="mb-4">
            <div class="flex gap-2">
                <div class="flex-1 relative ai-input-wrapper rounded-lg transition-all">
                    <input type="text" id="aiTextInput" placeholder="AI è¼¸å…¥ï¼šå“å®¢39å…ƒ 3ä»¶77æŠ˜" 
                           class="w-full bg-transparent text-[var(--color-text)] px-3 py-2 text-sm outline-none placeholder-gray-400 font-mono"
                           autocomplete="off">
                </div>
                <!-- Accent Green Dark Button -->
                <button id="aiSendBtn" class="bg-[var(--accent-green-dark)] hover:bg-[var(--accent-green)] text-white px-3 py-2 rounded-lg transition-colors flex items-center justify-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Promo Toolbar -->
        <div class="mb-4 flex space-x-2 overflow-x-auto pb-2 scrollbar-hide">
            <button class="promo-btn flex-1" onclick="applyStaticPromo('b1g1')">
                ğŸ è²·ä¸€é€ä¸€
            </button>
            <button class="promo-btn flex-1" onclick="applyStaticPromo('2nd40')">
                ğŸ·ï¸ ç¬¬2ä»¶4æŠ˜
            </button>
            <button class="promo-btn flex-1" onclick="applyStaticPromo('2nd10')">
                ğŸ’° ç¬¬2ä»¶10å…ƒ
            </button>
            <button class="promo-btn dynamic flex-1" onclick="applyDynamicRule('mix7977')">
                ğŸ”¥ 2ä»¶79æŠ˜/3ä»¶77æŠ˜
            </button>
        </div>

        <div id="itemList" class="space-y-2 mb-4 min-h-[50px]"></div>

        <div class="flex space-x-2 mb-4">
            <!-- Secondary Button Style -->
            <button id="addBtn" class="flex-1 bg-[var(--color-light-gray)] hover:bg-[var(--accent-pink)] text-[var(--color-text)] py-2 px-4 rounded border border-[var(--color-light-gray)] transition-colors text-sm">
                + æ‰‹å‹•æ–°å¢
            </button>
            <!-- Accent Green/Pink Style -->
            <button id="imageAddBtn" class="flex-1 bg-[var(--accent-green)]/30 hover:bg-[var(--accent-green)]/50 text-[var(--accent-green-dark)] py-2 px-4 rounded border border-[var(--accent-green)]/50 relative overflow-hidden text-sm flex items-center justify-center group transition-all">
                <input type="file" id="imageInput" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                </svg>
                å¾åœ–ç‰‡è¾¨è­˜
            </button>
        </div>

        <hr class="border-[var(--color-light-gray)] my-4">

        <div class="mt-4">
            <!-- Primary Button Style -->
            <button id="calcBtn" class="w-full calc-btn text-white font-medium py-2 px-4 rounded transition-colors">
                è¨ˆç®—å°è¨ˆ (å«è‡ªå‹•æŠ˜æ‰£)
            </button>
            <div id="resultArea" class="hidden mt-4 p-4 bg-[var(--accent-pink)]/30 rounded border border-[var(--accent-pink)] animate-fade-in">
                <div class="flex justify-between items-center text-sm text-[var(--color-gray-dark)] mb-1">
                    <span>å·²å‹¾é¸é …ç›®</span>
                    <span id="countDisplay">0 å€‹</span>
                </div>
                <div class="flex justify-between items-center text-2xl font-bold text-[var(--color-text)] mb-2">
                    <span>ç¸½é‡‘é¡</span>
                    <!-- Accent Pink Dark (Success/Highlight) -->
                    <span class="text-[var(--accent-pink-dark)]"><span id="totalSymbol">NT$</span> <span id="totalDisplay">0</span></span>
                </div>
                <div id="conversionArea" class="pt-2 border-t border-[var(--color-light-gray)] text-sm text-[var(--color-gray-dark)] flex flex-col space-y-1"></div>
            </div>
        </div>

        <div id="rateInfo" class="text-[10px] text-gray-500 mt-2 text-center">åŒ¯ç‡ä¾†æº: å³æ™‚æ›´æ–°</div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl border border-[var(--color-light-gray)] w-11/12 max-w-sm">
            <h2 class="text-lg font-bold text-[var(--color-text)] mb-4">è¨­å®š Google API Key</h2>
            <input type="password" id="apiKeyInput" placeholder="è¼¸å…¥ API Key" class="w-full bg-[var(--color-light-gray)] border border-[var(--accent-green)] rounded p-2 text-[var(--color-text)] mb-4 focus:border-[var(--accent-green-dark)] outline-none">
            <div class="flex justify-end space-x-2">
                <button id="closeApiKeyModal" class="px-4 py-2 text-gray-500 hover:text-[var(--accent-green)] text-sm">å–æ¶ˆ</button>
                <button id="saveApiKeyBtn" class="px-4 py-2 bg-[var(--accent-green)] text-white rounded hover:bg-[var(--accent-green-dark)] text-sm">å„²å­˜</button>
            </div>
            <div class="mt-2 text-xs text-center"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[var(--accent-green-dark)] hover:underline">å–å¾— API Key</a></div>
        </div>
    </div>

    <script>
        const itemList = document.getElementById('itemList');
        const addBtn = document.getElementById('addBtn');
        const calcBtn = document.getElementById('calcBtn');
        const resultArea = document.getElementById('resultArea');
        const totalDisplay = document.getElementById('totalDisplay');
        const totalSymbol = document.getElementById('totalSymbol');
        const countDisplay = document.getElementById('countDisplay');
        const currencySelector = document.getElementById('currencySelector');
        const conversionArea = document.getElementById('conversionArea');
        const loadingBlock = document.getElementById('loadingBlock');
        const loadingText = document.getElementById('loadingText');
        const rateInfo = document.getElementById('rateInfo');
        const aiTextInput = document.getElementById('aiTextInput');
        const aiSendBtn = document.getElementById('aiSendBtn');
        const imageInput = document.getElementById('imageInput');
        const apiKeyBtn = document.getElementById('apiKeyBtn');
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const closeApiKeyModal = document.getElementById('closeApiKeyModal');

        let exchangeRates = { TWD: 1, JPY: 4.65, CNY: 0.22 };
        let currentCurrency = 'TWD';
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';

        // API Key Logic
        function getApiKey() { return localStorage.getItem('gemini_api_key'); }
        function setApiKey(key) { localStorage.setItem('gemini_api_key', key); }
        function checkApiKey() {
            const key = getApiKey();
            if (!key) { apiKeyBtn.click(); return false; }
            return key;
        }

        apiKeyBtn.addEventListener('click', () => { apiKeyInput.value = getApiKey() || ''; apiKeyModal.classList.remove('hidden'); });
        closeApiKeyModal.addEventListener('click', () => apiKeyModal.classList.add('hidden'));
        saveApiKeyBtn.addEventListener('click', () => {
            if (apiKeyInput.value.trim()) { setApiKey(apiKeyInput.value.trim()); apiKeyModal.classList.add('hidden'); }
            else { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key'); }
        });

        async function fetchRates() {
            try {
                // ä½¿ç”¨ Google Search Grounding æŸ¥è©¢ TWD, JPY, CNY çš„åŒ¯ç‡
                const prompt = "What are the latest exchange rates for 1 TWD to JPY, and 1 TWD to CNY? Provide the result as a JSON object: {\"JPY\": <rate>, \"CNY\": <rate>}.";
                const rateText = await new Promise(async (resolve, reject) => {
                    const apiKey = getApiKey();
                    if (!apiKey) return resolve(JSON.stringify({ JPY: 4.65, CNY: 0.22 })); // Fallback if no key
                    
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        tools: [{ "google_search": {} }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "JPY": { "type": "NUMBER" },
                                    "CNY": { "type": "NUMBER" }
                                }
                            }
                        }
                    };

                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonText) {
                            resolve(jsonText);
                        } else {
                            reject(new Error("No JSON response from API."));
                        }
                    } catch (e) {
                        reject(e);
                    }
                });

                const parsedRates = JSON.parse(rateText);
                if (parsedRates.JPY && parsedRates.CNY) {
                    exchangeRates.JPY = parseFloat(parsedRates.JPY);
                    exchangeRates.CNY = parseFloat(parsedRates.CNY);
                    rateInfo.textContent = `åŒ¯ç‡ä¾†æº: AI å³æ™‚æ›´æ–° (1 TWD)`;
                } else {
                    throw new Error("Invalid rate format.");
                }
            } catch (e) {
                rateInfo.textContent = `åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼ (JPY: ${exchangeRates.JPY}, CNY: ${exchangeRates.CNY})`;
            }
        }
        fetchRates();

        function getCurrencyInfo(currency) {
            const map = { 'JPY': { symbol: 'Â¥', label: 'å††' }, 'CNY': { symbol: 'Â¥', label: 'Â¥' }, 'TWD': { symbol: 'NT$', label: 'å…ƒ' } };
            return map[currency] || map['TWD'];
        }

        currencySelector.addEventListener('change', (e) => {
            currentCurrency = e.target.value;
            const info = getCurrencyInfo(currentCurrency);
            document.querySelectorAll('.currency-label').forEach(el => el.textContent = info.label);
            totalSymbol.textContent = info.symbol;
            if (!resultArea.classList.contains('hidden')) calculateTotal();
        });

        // æ ¸å¿ƒï¼šå‰µå»ºé …ç›®å‡½æ•¸ (ä¿®æ”¹ï¼šcheckbox é è¨­ä¸å‹¾é¸)
        function createItem(name = '', price = '', rule = null) {
            const { label } = getCurrencyInfo(currentCurrency);
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 p-2 hover:bg-[var(--color-light-gray)] rounded group item-row border border-transparent hover:border-[var(--accent-green)] transition-all flash-success';
            
            const groupId = 'g_' + Math.random().toString(36).substr(2, 9);
            const originalPrice = price;

            let ruleHtml = '';
            if (rule === 'mix7977') {
                ruleHtml = '<span class="rule-badge">2ä»¶79æŠ˜/3ä»¶77æŠ˜</span><span class="dynamic-status status-none"></span>';
            }

            // èª¿æ•´é¡è‰²ç‚ºæ·ºè‰²ç³»
            div.innerHTML = `
                <input type="checkbox" class="w-5 h-5 rounded border-gray-400 bg-[var(--color-light-gray)] accent-[var(--accent-green-dark)] focus:ring-0 cursor-pointer item-checkbox ml-1">
                <div class="flex-1 flex items-center flex-wrap gap-1">
                    <input type="text" placeholder="å•†å“åç¨±" class="item-input name-input text-[var(--color-text)] placeholder-gray-500 w-full sm:w-auto" value="${name}">
                    ${ruleHtml}
                </div>
                <div class="flex items-center">
                    <input type="number" placeholder="é‡‘é¡" class="item-input price-input text-[var(--color-text)] placeholder-gray-500" 
                           value="${price}" 
                           data-original="${originalPrice}"
                           data-rule="${rule || ''}"
                           data-group="${groupId}">
                    <span class="text-gray-500 ml-1 text-sm currency-label whitespace-nowrap">${label}</span>
                </div>
                <!-- Delete Button -->
                <button class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-[var(--accent-pink-dark)] transition-opacity delete-btn px-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
            `;
            
            div.querySelector('.delete-btn').addEventListener('click', () => { div.remove(); calculateTotal(); });
            
            const pInput = div.querySelector('.price-input');
            pInput.addEventListener('input', (e) => {
                if (!e.target.dataset.calculating) {
                    e.target.dataset.original = e.target.value;
                }
                calculateTotal();
            });

            const cb = div.querySelector('.item-checkbox');
            cb.addEventListener('change', (e) => {
                div.classList.toggle('checked-item', e.target.checked);
                calculateTotal();
            });
            
            itemList.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        // --- éœæ…‹ä¿ƒéŠ· ---
        function applyStaticPromo(type) {
            const checkedRows = Array.from(document.querySelectorAll('.item-row')).filter(row => row.querySelector('.item-checkbox').checked);
            if (checkedRows.length === 0) { alert('è«‹å…ˆå‹¾é¸å•†å“ï¼'); return; }

            checkedRows.forEach(row => {
                const input = row.querySelector('.price-input');
                input.value = input.dataset.original;
            });

            if (type === 'b1g1') {
                if (checkedRows.length === 1) cloneItem(checkedRows[0], 0, ' (è´ˆå“)');
                else checkedRows.forEach((row, i) => { if ((i + 1) % 2 === 0) row.querySelector('.price-input').value = 0; });
            } else if (type === '2nd40') {
                if (checkedRows.length === 1) {
                    const original = parseFloat(checkedRows[0].querySelector('.price-input').dataset.original);
                    cloneItem(checkedRows[0], original * 0.4, ' (4æŠ˜)');
                } else checkedRows.forEach((row, i) => { if ((i + 1) % 2 === 0) row.querySelector('.price-input').value = parseFloat(row.querySelector('.price-input').dataset.original) * 0.4; });
            } else if (type === '2nd10') {
                if (checkedRows.length === 1) cloneItem(checkedRows[0], 10, ' (åŠ è³¼åƒ¹)');
                else checkedRows.forEach((row, i) => { if ((i + 1) % 2 === 0) row.querySelector('.price-input').value = 10; });
            }
            calculateTotal();
        }

        function cloneItem(row, newPrice, suffix) {
            const name = row.querySelector('.name-input').value + suffix;
            const original = row.querySelector('.price-input').dataset.original;
            createItem(name, newPrice);
            itemList.lastElementChild.querySelector('.price-input').dataset.original = original;
        }

        // --- å‹•æ…‹è¦å‰‡å¥—ç”¨ ---
        function applyDynamicRule(ruleCode) {
            const checkedRows = Array.from(document.querySelectorAll('.item-row')).filter(row => row.querySelector('.item-checkbox').checked);
            if (checkedRows.length === 0) return;
            
            checkedRows.forEach(row => {
                const input = row.querySelector('.price-input');
                input.dataset.rule = ruleCode;
                const nameContainer = row.querySelector('.flex-1');
                if (!nameContainer.querySelector('.rule-badge')) {
                    nameContainer.insertAdjacentHTML('beforeend', '<span class="rule-badge">2ä»¶79æŠ˜/3ä»¶77æŠ˜</span><span class="dynamic-status status-none"></span>');
                }
                if (checkedRows.length === 1) {
                    const name = row.querySelector('.name-input').value;
                    const original = input.dataset.original;
                    // è‡ªå‹•è£œé½Š 3 å€‹ (æ–°é …ç›®é è¨­æœªå‹¾é¸)
                    createItem(name, original, ruleCode);
                    createItem(name, original, ruleCode);
                }
            });
            calculateTotal();
        }

        // --- å‹•æ…‹è¨ˆç®—é‚è¼¯ ---
        function updateDynamicPrices() {
            const allRows = Array.from(document.querySelectorAll('.item-row'));
            const mixRows = allRows.filter(row => {
                const input = row.querySelector('.price-input');
                const cb = row.querySelector('.item-checkbox');
                return cb.checked && input.dataset.rule === 'mix7977';
            });

            const count = mixRows.length;
            let multiplier = 1;
            let statusText = '';
            let statusClass = 'status-none';
            
            if (count === 2) { 
                multiplier = 0.79; 
                statusText = 'âœ… 2ä»¶79æŠ˜'; 
                statusClass = 'status-79';
            } else if (count >= 3) { 
                multiplier = 0.77; 
                statusText = 'âœ… 3ä»¶77æŠ˜'; 
                statusClass = 'status-77';
            } else {
                statusText = 'å°šæœªç¬¦åˆ';
                statusClass = 'status-none';
            }

            mixRows.forEach(row => {
                const input = row.querySelector('.price-input');
                const original = parseFloat(input.dataset.original) || 0;
                const statusSpan = row.querySelector('.dynamic-status');
                
                if (statusSpan) {
                    statusSpan.textContent = statusText;
                    statusSpan.className = `dynamic-status ${statusClass}`;
                }

                input.dataset.calculating = "true";
                if (multiplier !== 1) {
                    input.value = parseFloat((original * multiplier).toFixed(1));
                    // æ ¹æ“šæ–°çš„ä¸»é¡Œè‰²èª¿æ•´é¡è‰²
                    input.style.color = multiplier === 0.77 ? 'var(--accent-green-dark)' : 'var(--accent-pink-dark)'; // æ·±ç¶ è‰²æˆ–æ·ºæš–æ©˜
                } else {
                    input.value = original;
                    input.style.color = 'var(--color-text)'; // æ¢å¾©ä¸»é¡Œæ–‡å­—è‰²
                }
                input.dataset.calculating = "false";
            });
        }

        // --- AI è™•ç† ---
        async function callGemini(apiKey, payload) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error('API Error');
            return await response.json();
        }

        function robustJsonParse(text) {
            try { return JSON.parse(text); } catch (e) {
                try { return JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim()); } 
                catch (e2) { 
                    const match = text.match(/\[[\s\S]*\]/); 
                    if(match) return JSON.parse(match[0]); 
                }
            }
            return null;
        }

        async function processAIRequest(userText, base64Data = null, mimeType = null) {
            const apiKey = checkApiKey(); if (!apiKey) return;
            loadingBlock.classList.remove('hidden');
            loadingText.textContent = "AI åˆ†æä¸­...";

            const promptText = `
                You are a smart shopping calculator. User Input: "${userText}"
                
                STRICT OUTPUT RULES (TW Retail Support):

                PRIORITY: If "Member Price" (æœƒå“¡åƒ¹) or "Card Price" (é»‘å¡åƒ¹) exists alongside Original Price, use the LOWER price.

                CASE 1: "Buy 1 Get 1 Free" (è²·ä¸€é€ä¸€) detected?
                - ACTION: Return 2 items (Item 1: Price, Item 2: 0).

                CASE 2: "Add $1 get 1 more" (åŠ 1å…ƒå¤šä¸€ä»¶) detected? (Watsons/Cosmed)
                - ACTION: Return 2 items.
                - Item 1: Original Price.
                - Item 2: 1.
                - JSON Example: [{"name": "Item", "price": 199}, {"name": "Item (åŠ è³¼)", "price": 1}]

                CASE 3: "N items for $Total" (e.g. 3ä»¶99å…ƒ, 2ä»¶88å…ƒ) detected? (CVS)
                - ACTION: Calculate average (Total / N).
                - Return N items with that average price.
                - Example "3ä»¶99": Return 3 items, each 33.

                CASE 4: "2nd item % off" (ç¬¬2ä»¶XæŠ˜) or "2nd item fixed price" (ç¬¬2ä»¶10å…ƒ) detected?
                - ACTION: Return 2 items with calculated/fixed prices.

                CASE 5: "Mix & Match" (specifically "2ä»¶79æŠ˜, 3ä»¶77æŠ˜") detected?
                - ACTION: Return ONE item with special rule tag "mix7977".
                - Note: Do NOT expand. The system handles it.

                CASE 6: Default (No promo)
                - JSON: [{"name": "Item", "price": 100}]
                
                Return JSON Array ONLY. No Markdown.
            `;

            try {
                const parts = [{ text: promptText }];
                if (base64Data) parts.push({ inline_data: { mime_type: mimeType, data: base64Data } });

                const data = await callGemini(apiKey, { contents: [{ parts: parts }] });
                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                const items = robustJsonParse(rawText);

                if (Array.isArray(items)) {
                    items.forEach(i => {
                        if (i.rule === 'mix7977') {
                            // ç•¶ AI è¾¨è­˜åˆ°ã€Œä»»é¸æŠ˜æ‰£ã€æ™‚ï¼Œè‡ªå‹•é è¨­åŠ å…¥ 3 ä»¶ä»¥ç¬¦åˆæœ€å„ªæŠ˜æ‰£
                            createItem(i.name, i.price, 'mix7977');
                            createItem(i.name, i.price, 'mix7977'); 
                            createItem(i.name, i.price, 'mix7977');
                        } else {
                            createItem(i.name, i.price);
                        }
                    });
                } else if (items && items.name) {
                    createItem(items.name, items.price, items.rule);
                } else {
                    createItem("è¾¨è­˜å¤±æ•—", 0);
                }
                
                if(!resultArea.classList.contains('hidden')) calculateTotal();

            } catch (e) { console.error(e); createItem("é€£ç·šéŒ¯èª¤", 0); } 
            finally { loadingBlock.classList.add('hidden'); }
        }

        aiSendBtn.addEventListener('click', () => {
            const text = aiTextInput.value.trim();
            if (!text) return;
            processAIRequest(text);
            aiTextInput.value = '';
        });
        aiTextInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') aiSendBtn.click(); });

        imageInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (files.length === 0) return;
            for (let file of files) {
                const base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = () => r(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });
                await processAIRequest("Analyze items", base64, file.type);
            }
            imageInput.value = '';
        });

        addBtn.addEventListener('click', () => createItem());
        calcBtn.addEventListener('click', calculateTotal);

        function calculateTotal() {
            updateDynamicPrices();
            let total = 0, count = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                if (row.querySelector('.item-checkbox').checked) {
                    const price = parseFloat(row.querySelector('.price-input').value) || 0;
                    total += price;
                    count++;
                }
            });
            const displayTotal = currentCurrency === 'JPY' ? Math.round(total) : parseFloat(total.toFixed(2));
            totalDisplay.textContent = displayTotal.toLocaleString();
            countDisplay.textContent = `${count} å€‹`;
            
            let baseTWD = (currentCurrency === 'TWD') ? total : total / (exchangeRates[currentCurrency] || 1);
            let html = '';
            ['TWD', 'JPY', 'CNY'].forEach(c => {
                if (c !== currentCurrency) {
                    const val = baseTWD * (exchangeRates[c] || 1);
                    const formatted = c === 'JPY' ? Math.round(val) : val.toFixed(1);
                    const info = getCurrencyInfo(c);
                    html += `<div class="flex justify-between"><span>ç´„åˆ ${c}</span><span class="text-gray-500">${info.symbol} ${Number(formatted).toLocaleString()}</span></div>`;
                }
            });
            conversionArea.innerHTML = html;
            resultArea.classList.remove('hidden');
        }

        createItem(); 
    </script>
</body>
</html>
